datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}


model Customer {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String?
  phone            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // 3B system fields
  mfsnMemberId     String?  @unique
  currentPlanTier  String?  @default("basic") // basic, analyzer, welcome, ultimate
  stripeCustomerId String?  @unique

  // Credit scores
  scoreTu          Int?
  scoreEq          Int?
  scoreEx          Int?
  scoreAvg         Int?

  // Tracking
  lastReportDate   DateTime?
  nextRoundDate    DateTime?
  lastRoundSent    String?  // "round1", "round2", etc.
  disputableCount  Int?     @default(0)
  lastAction       String?

  snapshots        Snapshot[]
  disputePlans     DisputePlan[]
  letters          Letter[]
}

model Snapshot {
  id            String   @id @default(uuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Raw data from MFSN/Epic
  rawData       Json
  extractedJson Json?   // Normalized 3B Standard format

  // Quick access scores
  scoreTu       Int?
  scoreEq       Int?
  scoreEx       Int?

  status        String   @default("pending") // pending, ready, imported

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([customerId])
}

model DisputePlan {
  id           String   @id @default(uuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Analyzer output + multi-round plan
  analyzerData Json
  planData     Json

  currentRound Int      @default(1)
  totalRounds  Int      @default(3)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([customerId])
}

model Letter {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  round      Int      // 1, 2, 3, etc.
  bureau     String   // TU, EQ, EX, or "furnisher"
  style      String   @default("general") // general, daraine, smitty

  content    String   @db.Text
  status     String   @default("draft") // draft, sent, response_received

  sentAt     DateTime?
  responseAt DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([customerId, round])
}
